---
layout:              post
title:               "FFmpegç³»åˆ—ä¹‹ç¼–è¯‘"
subtitle:            " \"FFmpegåœ¨macOSå’ŒiOSä¸‹çš„ç¼–è¯‘è¯¦è§£\""
description:         "FFmpegåœ¨macOSå’ŒiOSä¸‹çš„ç¼–è¯‘è¯¦è§£"
date:                2019-01-05 00:00:00 +0800
author:              "SNLO"
header-img:          "img/header_code.jpg"
catalog:             true
tags:
- FFmpeg
---

## ç®€ä»‹

[è·³è¿‡ç®€ä»‹](#build)

#### FFmpegä»‹ç»

FFmpegåˆ›å§‹äºº[Fabrice Bellard](https://bellard.org/)ã€‚

FFmpegæ˜¯é¢†å…ˆçš„å¤šåª’ä½“æ¡†æ¶ï¼Œèƒ½å¤Ÿè§£ç ï¼Œç¼–ç ï¼Œ è½¬ç ï¼Œå¤ç”¨ï¼Œè§£å¤ç”¨**ï¼Œ**æµå¼ä¼ è¾“**ï¼Œ**è¿‡æ»¤å’Œæ’­æ”¾äººç±»å’Œæœºå™¨åˆ›å»ºçš„ä»»ä½•å†…å®¹ã€‚å®ƒæ”¯æŒæœ€æ™¦æ¶©éš¾æ‡‚çš„å¤ä»£æ ¼å¼ï¼Œç›´è‡³æœ€å‰æ²¿ã€‚æ— è®ºå®ƒä»¬æ˜¯ç”±æŸäº›æ ‡å‡†å§”å‘˜ä¼šï¼Œç¤¾åŒºè¿˜æ˜¯å…¬å¸è®¾è®¡çš„ã€‚å®ƒè¿˜å…·æœ‰é«˜åº¦å¯ç§»æ¤æ€§ï¼šFFmpeg åœ¨å„ç§æ„å»ºç¯å¢ƒã€æœºå™¨æ¶æ„å’Œé…ç½®ä¸‹ï¼Œè·¨Linuxã€Mac OS Xã€Microsoft Windowsã€BSDã€Solarisç­‰ç¼–è¯‘ã€‚

#### FFmpegé¡¹ç›®ç»“æ„ï¼š

å®ƒåŒ…å«å¯ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„libavcodecï¼Œlibavutilï¼Œlibavformatï¼Œlibavfilterï¼Œlibavdeviceï¼Œlibswscaleå’Œlibswresampleã€‚ä»¥åŠæœ€ç»ˆç”¨æˆ·å¯ç”¨äºè½¬ç å’Œæ’­æ”¾çš„ffmpegï¼Œffplayå’Œffprobeã€‚

##### Library:

- <a href= "https://ffmpeg.org/libavutil.html" target="_blank">libavutil</a>æ˜¯ä¸€ä¸ªåŒ…å«ç®€åŒ–ç¼–ç¨‹åŠŸèƒ½çš„åº“ï¼ŒåŒ…æ‹¬éšæœºæ•°ç”Ÿæˆå™¨ï¼Œæ•°æ®ç»“æ„ï¼Œæ•°å­¦ä¾‹ç¨‹ï¼Œæ ¸å¿ƒå¤šåª’ä½“å®ç”¨ç¨‹åºç­‰ç­‰ã€‚
- <a href= "https://ffmpeg.org/libavcodec.html" target="_blank">libavcodec</a>æ˜¯ä¸€ä¸ªåŒ…å«ç”¨äºéŸ³é¢‘/è§†é¢‘ç¼–è§£ç å™¨çš„è§£ç å™¨å’Œç¼–ç å™¨çš„åº“ã€‚
- <a href= "https://ffmpeg.org/libavformat.html" target="_blank">libavformat</a>æ˜¯ä¸€ä¸ªåŒ…å«å¤šåª’ä½“å®¹å™¨æ ¼å¼çš„è§£å¤ç”¨å™¨å’Œå¤ç”¨å™¨çš„åº“ã€‚
- <a href= "https://ffmpeg.org/libavdevice.html" target="_blank">libavdevice</a>æ˜¯ä¸€ä¸ªåŒ…å«è¾“å…¥å’Œè¾“å‡ºè®¾å¤‡çš„åº“ï¼Œç”¨äºä»è®¸å¤šå¸¸è§çš„å¤šåª’ä½“è¾“å…¥/è¾“å‡ºè½¯ä»¶æ¡†æ¶ä¸­è·å–å’Œå‘ˆç°ï¼ŒåŒ…æ‹¬Video4Linuxï¼ŒVideo4Linux2ï¼ŒVfWå’ŒALSAã€‚
- <a href= "https://ffmpeg.org/libavfilter.html" target="_blank">libavfilter</a>æ˜¯ä¸€ä¸ªåŒ…å«åª’ä½“è¿‡æ»¤å™¨çš„åº“ã€‚
- <a href= "https://ffmpeg.org/libswscale.html" target="_blank">libswscale</a>æ˜¯ä¸€ä¸ªæ‰§è¡Œé«˜åº¦ä¼˜åŒ–çš„å›¾åƒç¼©æ”¾å’Œè‰²å½©ç©ºé—´/åƒç´ æ ¼å¼è½¬æ¢æ“ä½œçš„åº“ã€‚
- <a href= "https://ffmpeg.org/libswresample.html" target="_blank">libswresample</a>æ˜¯ä¸€ä¸ªæ‰§è¡Œé«˜åº¦ä¼˜åŒ–çš„éŸ³é¢‘é‡é‡‡æ ·ï¼Œé‡æ–°çŸ©é˜µåŒ–å’Œæ ·æœ¬æ ¼å¼è½¬æ¢æ“ä½œçš„åº“ã€‚

##### Tool:

- <a href= "https://ffmpeg.org/ffmpeg.html" target="_blank">ffmpeg</a>ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥å¤šåª’ä½“ä¹‹é—´è¿›è¡Œæ ¼å¼è½¬æ¢ã€‚
- <a href= "https://ffmpeg.org/ffplay.html" target="_blank">ffplay</a>ä¸€ä¸ªåŸºäºSDLå’ŒFFmpegåº“çš„ç®€å•åª’ä½“æ’­æ”¾å™¨ã€‚
- <a href= "https://ffmpeg.org/ffprobe.html" target="_blank">ffprobe</a>ç®€å•çš„å¤šåª’ä½“æµåˆ†æå™¨ã€‚

#### FFmpegçš„å°æ’æ›²

<a href= "https://github.com/FFmpeg/FFmpeg" target="_blank">FFmpeg</a>è¿˜æœ‰ä¸ªåˆ†èº«<a href= "https://github.com/libav/libav" target="_blank">Libav</a>ï¼Œä»–ä»¬æœ€å¼€å§‹å…¶å®æ˜¯ä¸€ä¸ªå›¢é˜Ÿçš„æˆå‘˜ï¼Œç”±äºFFmpegä¸ºäº†è¿åˆå¼€å‘å•†ï¼Œå¯¼è‡´çš„ä»£ç å‡Œä¹±å’ŒABIä¸ç¨³å®šè€Œä½¿å¾—å›¢é˜Ÿåˆ†è£‚äº†ï¼ŒLibavæ˜¯FFmpegé•œåƒè¿‡æ¥çš„ï¼Œæ¯å½“Libavæœ‰æ›´æ–°çš„æ—¶å€™FFmpegä¼šå»æ‹‰å–æœ€æ–°çš„ä¿®æ”¹ã€‚å¯ä»¥è¯´FFmpegæ˜¯Libavçš„è¶…é›†ï¼Œå¹¶ä¸”FFmpegä¼¼ä¹æ›´å—æ¬¢è¿ã€‚

<p id = "build"></p>

## ç¼–è¯‘

#### macOS - FFmpeg

<a href= "https://trac.ffmpeg.org/wiki/CompilationGuide/macOS" target="_blank">å®˜æ–¹ç¼–è¯‘æŒ‡å—</a>

##### ç¼–è¯‘ç¯å¢ƒï¼š

- <a href= "https://brew.sh" target="_blank">Homebrew</a> 
- <a href= "https://ffmpeg.org" target="_blank">FFmpeg</a>

##### å®‰è£…HomeBrew:

macè‡ªå¸¦brew,ä¸è¿‡ç‰ˆæœ¬æœ‰å¯èƒ½æ¯”è¾ƒè€äº†ï¼Œéœ€è¦æ›´æ–°

```sh
$ xcode-select --install #Xcodeæä¾›ç¼–è¯‘ç¯å¢ƒ
$ brew update #æ›´æ–°,æœ‰å¯èƒ½ä¼šå¾ˆæ…¢ï¼Œæ…¢åˆ°ä»¥ä¸ºæ²¡ååº”ï¼Œå¯ä»¥å…ˆå¸è½½å†å®‰è£…ï¼Œä¹Ÿå¯ä»¥ç»§ç»­ç­‰å¾…
$ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall)" #å¸è½½
$ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" #å®‰è£…
$ brew cleanup # æ¸…ç†æ‰€æœ‰åŒ…çš„æ—§ç‰ˆæœ¬
```

##### å®‰è£…FFmpegï¼š

```sh

$ brew info ffmpeg #è·å–å®‰è£…é€‰é¡¹å¸®åŠ©
$ brew install ffmpeg #å®‰è£…FFmpeg
#å®‰è£…FFmpegå®Œå…¨ç‰ˆï¼Œæ‰€æœ‰çš„å¯é€‰ä¾èµ–é¡¹éƒ½é€‰ä¸­ã€‚è¿™å¯èƒ½éœ€è¦èŠ±è´¹ä¸Šä¸å°‘çš„æ—¶é—´ï¼Œæœ‰å¯èƒ½ä½ çš„ç½‘ç»œçŠ¶æ€ä¸ä½³ä¸­æ–­äº†ï¼Œé‚£è¿˜å¾—ä»æ–°æ‰§è¡Œä¸€æ¬¡å®‰è£…å‘½ä»¤ï¼Œå¥½çš„æ˜¯ä¹‹å‰ä¸‹è½½æˆåŠŸè¿‡çš„ä¸ä¼šå†æ¬¡ä¸‹è½½äº†
$ brew install ffmpeg \
--with-aom \
--with-chromaprint \
--with-fdk-aac \
--with-fontconfig \
--with-freetype \
--with-frei0r \
--with-game-music-emu \
--with-libass \
--with-libbluray \
--with-libbs2b \
--with-libcaca \
--with-libgsm \
--with-libmodplug \
--with-librsvg \
--with-libsoxr \
--with-libssh \
--with-libvidstab \
--with-libvmaf \
--with-opencore-amr \
--with-openh264 \
--with-openjpeg \
--with-openssl \
--with-rtmpdump \
--with-rubberband \
--with-speex \
--with-srt \
--with-tesseract \
--with-two-lame \
--with-wavpack \
--with-webp \
--with-zeromq \
--with-zimg
```

å¦‚æœå‡ºç°`Empty installation`å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯å‚è€ƒè¿™ä¸ª<a href= "https://github.com/Homebrew/legacy-homebrew/issues/47625" target="_blank">issues</a>

```sh
Type `exit' to return and finalize the installation
Install to this prefix: /usr/local/Cellar/ffmpeg/4.1_1......
bash-3.2$ exit
exit
Error: Empty installation
```

å®‰è£…æˆåŠŸåæŸ¥çœ‹ç‰ˆæœ¬ä¼šå¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼Œæˆ‘æ˜¯å®‰è£…çš„å®Œæ•´ç‰ˆçš„FFmpeg

```sh
$ ffmpeg -version #æ£€æµ‹æ˜¯å¦å®‰è£…æˆåŠŸ
ffmpeg version 4.1 Copyright (c) 2000-2018 the FFmpeg developers
built with Apple LLVM version 10.0.0 (clang-1000.11.45.5)
configuration: --prefix=/usr/local/Cellar/ffmpeg/4.1_1 --enable-shared --enable-pthreads --enable-version3 --enable-hardcoded-tables --enable-avresample --cc=clang --host-cflags=-I/System/Library/Frameworks/JavaVM.framework/Versions/Current/Headers/ --host-ldflags= --enable-ffplay --enable-gpl --enable-libmp3lame --enable-libopus --enable-libsnappy --enable-libtheora --enable-libvorbis --enable-libvpx --enable-libx264 --enable-libx265 --enable-libxvid --enable-lzma --enable-chromaprint --enable-frei0r --enable-libaom --enable-libass --enable-libbluray --enable-libbs2b --enable-libcaca --enable-libfdk-aac --enable-libfontconfig --enable-libfreetype --enable-libgme --enable-libgsm --enable-libmodplug --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libopenh264 --enable-librsvg --enable-librtmp --enable-librubberband --enable-libsoxr --enable-libspeex --enable-libsrt --enable-libssh --enable-libtesseract --enable-libtwolame --enable-libvidstab --enable-libvmaf --enable-libwavpack --enable-libwebp --enable-libzimg --enable-libzmq --enable-opencl --enable-openssl --enable-videotoolbox --enable-libopenjpeg --disable-decoder=jpeg2000 --extra-cflags=-I/usr/local/Cellar/openjpeg/2.3.0/include/openjpeg-2.3 --enable-nonfree
libavutil      56. 22.100 / 56. 22.100
libavcodec     58. 35.100 / 58. 35.100
libavformat    58. 20.100 / 58. 20.100
libavdevice    58.  5.100 / 58.  5.100
libavfilter     7. 40.101 /  7. 40.101
libavresample   4.  0.  0 /  4.  0.  0
libswscale      5.  3.100 /  5.  3.100
libswresample   3.  3.100 /  3.  3.100
libpostproc    55.  3.100 / 55.  3.100
```

æ­¤æ—¶å°±å¯ä»¥åœ¨ç»ˆç«¯æ‰§è¡Œffmpegå‘½ä»¤è¿›è¡Œå¤šåª’ä½“å¤„ç†äº†ã€‚

#### iOS - FFmpeg

##### ç¼–è¯‘ç¯å¢ƒï¼š

- <a href= "http://yasm.tortall.net" target="_blank">YASM</a>
- <a href= "https://github.com/FFmpeg/gas-preprocessor" target="_blank">gas-preprocessor</a>
- <a href= "https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank">FFmpeg-iOS-build-script</a>

##### å®‰è£…yasmï¼š

```sh
$ brew install yasm
$ yasm --version
yasm 1.3.0
Compiled on Oct 14 2018.
Copyright (c) 2001-2014 Peter Johnson and other Yasm developers.
Run yasm --license for licensing overview and summary.
```

##### ä½¿ç”¨FFmpeg-iOS-build-script

åœ¨Githubä¸Šä¸‹è½½ä¸‹æ¥æ‰¾åˆ°`build-ffmpeg.sh`ï¼Œæ„Ÿè°¢è¿™ä¸ªå›½å¤–çš„æœ‹å‹ï¼Œå¯ä»¥ç»™ä»–starã€‚

åœ¨`build-ffmpeg.sh`æ–‡ä»¶ä¸­ä¿®æ”¹`FF_VERSION`ã€`CONFIGURE_FLAGS`ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘åªä¿®æ”¹äº†ç‰ˆæœ¬ä¿¡æ¯ä¸º`4.1`ï¼Œæ²¡æœ‰ä¿®æ”¹ç¼–è¯‘çš„é…ç½®å‚æ•°ã€‚

![1](https://snlo.app/img/blog_img/190105/1.jpg)

CONFIGURE_FLAGS éƒ¨åˆ†é…ç½®é€‰é¡¹ï¼š

```sh
$ cd ~/ffmpeg-4.1 
$ ./configure --help
```

```sh
Configuration options:
  --disable-static         do not build static libraries [no]
  --enable-shared          build shared libraries [no]
  --enable-small           optimize for size instead of speed
  --disable-runtime-cpudetect disable detecting CPU capabilities at runtime (smaller binary)
  --enable-gray            enable full grayscale support (slower color)
  --disable-swscale-alpha  disable alpha channel support in swscale
  --disable-all            disable building components, libraries and programs
  --disable-autodetect     disable automatically detected external libraries [no]

Program options:
  --disable-programs       do not build command line programs
  --disable-ffmpeg         disable ffmpeg build
  --disable-ffplay         disable ffplay build
  --disable-ffprobe        disable ffprobe build
 .
 .
 .
  
```

éœ€è¦ç²¾ç®€å’Œä¼˜åŒ–FFmpegçš„è¯ï¼Œå¯ä»¥åœ¨`build-ffmpeg.sh`è„šæœ¬æ–‡ä»¶ä¸­ä¿®æ”¹`CONFIGURE_FLAGS`å‚æ•°ã€‚æ¯”å¦‚æ·»åŠ å‚æ•°ï¼š

```sh
--disable-muxers         disable all muxers
--disable-avdevice       disable libavdevice build
--enable-small           optimize for size instead of speed
--disable-sdl2           disable sdl2 [autodetect]
Program options:
  --disable-programs       do not build command line programs
  --disable-ffmpeg         disable ffmpeg build
  --disable-ffplay         disable ffplay build
  --disable-ffprobe        disable ffprobe build
```

æ­¤æ—¶`CONFIGURE_FLAGS`å€¼ä¸ºï¼š

```swift
CONFIGURE_FLAGS="--enable-cross-compile --disable-debug --disable-programs \
                 --disable-doc --enable-pic \
                 --enable-gpl --enable-small --disable-sdl2 --disable-ffmpeg --disable-ffplay --disable-ffprobe --disable-avdevice --disable-network --disable-postproc"
```

åœ¨ç»ˆç«¯ä¸­è¿è¡Œ`build-ffmpeg.sh`æ–‡ä»¶ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¾—åˆ°4ä¸ªæ–‡ä»¶å¤¹ï¼š

```sh
ffmpeg-4.1
FFmpeg-iOS
scratch
thin
```

## é›†æˆ

#### iOSé›†æˆFFmpegé™æ€åº“

æŠŠ`FFmpeg-iOS`ä¸­çš„æ–‡ä»¶å…¨éƒ¨æ‹–å…¥åˆ°é¡¹ç›®å·¥ç¨‹é‡Œé¢ï¼Œå†åˆ°`TARGETS->Build Phases->Link Binary With Libraries`ä¸­æ·»åŠ ä¸‹é¢å‡ ä¸ªä¾èµ–åº“ï¼š

![2](https://snlo.app/img/blog_img/190105/2.jpg)

#### iOSé›†æˆFFmpeg Tool

- æ‰¾åˆ°`./ffmpeg-4.1`ä¸­çš„`fftools`æ‹–å…¥å·¥ç¨‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™`C/C++`å»è°ƒç”¨`FFmpeg-Tool`ã€‚**æ³¨æ„**å¦‚æœæ˜¯`C++`å†™çš„Toolè¯ï¼Œä¸Šé¢çš„Librariesè¿˜éœ€å†æ·»åŠ ä¸€ä¸ª`libc++.tbd`ã€‚
- åœ¨TARGETS->Build Ssting`sä¸­æœç´¢`header searché€‰é¡¹æ·»åŠ `$(PROJECT_DIR)/.../includeã€$(PROJECT_DIR)/fftools`ã€‚
- æŠ¥é”™çš„ä»£ç å—å’Œ`not found`çš„`#include`è¯¥æ³¨é‡Šæ‰çš„å°±ç›´æ¥æ³¨é‡Šæ‰å¥½äº†ï¼Œå› ä¸ºæ ¹æœ¬å°±æ²¡ç”¨åˆ°ã€‚
- é¡¹ç›®ä¸­åªå…è®¸ä¸€ä¸ª`main`å‡½æ•°ï¼Œæ‰€ä»¥åœ¨`ffmpeg.c`æ–‡ä»¶ä¸­ä¿®æ”¹`main -> ffmpeg_main`å¹¶åœ¨å¤´æ–‡ä»¶ä¸­å£°æ˜ã€‚
- åœ¨`ffmpeg.c`æ–‡ä»¶ä¸­å¯¼å…¥ï¼š`#include <pthread/pthread.h>`å¤´æ–‡ä»¶

## ä¼˜åŒ–

åœ¨`ffmpeg.c`æ–‡ä»¶ä¸­ `exit_program`æ˜¯é€€å‡ºçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸éœ€è¦ï¼Œç›´æ¥å…¨å±€æ”¹åä¸º`ffmpeg_cleanup`ã€‚å†åœ¨`ffmpeg_cleanup`å‡½æ•°ä¸­ç»“å°¾å¤„æ·»åŠ ä¸€ä¸‹ä»£ç ï¼š

```swift
nb_filtergraphs = 0;
nb_output_files = 0;
nb_output_streams = 0;
nb_input_files = 0;
nb_input_streams = 0;
```

å½“è¾“å‡ºæ–‡ä»¶å·²ç»å­˜åœ¨æ—¶ï¼ŒAPPä¼šé—ªé€€ã€‚ä¸ºé˜²æ­¢è¿™ç§æƒ…å†µé—ªé€€ï¼Œåœ¨`static void assert_file_overwrite(const char *filename)`å‡½æ•°å¼€å¤´æ·»åŠ `avpriv_io_delete(filename);`ç§»é™¤æ—§æ–‡ä»¶ã€‚

æ›´å¤šçš„ä¼˜åŒ–è¯·è‡ªè¡ŒæŸ¥æ‰¾ï¼Œå› ä¸ºä¸åŒç‰ˆæœ¬çš„ä¼˜åŒ–å¤§å¤šæœ‰å·®å¼‚ï¼Œè€Œä¸”å‡ ä¹æ²¡3ä¸ªæœˆå°±åˆä¸€æ¬¡ç‰ˆæœ¬æ›´æ–°ã€‚å¦‚æœå«Œéº»çƒ¦çš„è¯ï¼Œé‚£å°±æ”¾å¼ƒå®šåˆ¶åŒ–ç¼–è¯‘å§ï¼Œè¿™ä¸ªå¼€æºé¡¹ç›®<a href= "https://github.com/tanersener/mobile-ffmpeg" target="_blank">MobileFFmpeg</a>å¯ä»¥äº†è§£ä¸‹ã€‚

## ä½¿ç”¨

```swift
#import "ViewController.h"
#import "ffmpeg.h"

@interface ViewController ()
@end

@implementation ViewController

- (void)viewDidLoad {
	[super viewDidLoad];
	// Do any additional setup after loading the view, typically from a nib.
	NSArray * array = @[@"ffmpeg",
						@"-i",
						@"/Users/snloveydus/Desktop/GitHub/NEW/NEW/video.mov",
						@"-f",
						@"wav",
						@"-ar",
						@"16000",
						@"/Users/snloveydus/Desktop/GitHub/NEW/NEW/video.wav"
						];
	int argc = (int)array.count;
	char **argv = calloc(argc, sizeof(char *));
	for (int i = 0; i < array.count; i ++) {
		argv[i] = (char *)[array[i] UTF8String];
	}
	if (!ffmpeg_main(argc, argv)) {
		NSLog(@"ğŸ‘Œ");
	}
}


@end
```

æœ¬æ–‡é¡¹ç›®ï¼š<a href= "https://github.com/snlo/SNFFmpeg" target="_blank">DEMO</a>ã€‚æˆ‘ä¼šåŠæ—¶æ›´æ–°é¡¹ç›®ä¸­FFmpegçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä¼šé™†ç»­å¼€å‘ä¸€ä¸ªiOS APPæ¥ä½¿ç”¨FFmpegã€‚

## å‚è€ƒ

<a href= "https://trac.ffmpeg.org" target="_blank">FFmpegÂ Wiki</a>

<a href= "https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank">FFmpeg-iOS-build-script</a>

<a href= "https://github.com/tanersener/mobile-ffmpeg" target="_blank">MobileFFmpeg </a>